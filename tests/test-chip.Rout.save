
R version 3.0.3 (2014-03-06) -- "Warm Puppy"
Copyright (C) 2014 The R Foundation for Statistical Computing
Platform: x86_64-unknown-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> ###################################################################################################
> # This script tests the ChIP capabilities of the 'csaw' package.
> 
> suppressPackageStartupMessages(library(csaw))
> source("simsam.R")
> 
> # First, we set up some functions to generate some random SAM files.
> 
> regen <- function(nreads, chromos, outfname) {
+ 	pos.chr<-sample(length(chromos), nreads, replace=TRUE)
+ 	pos.pos<-rep(0, nreads)
+ 	str<-rep(0, nreads)
+ 	for (i in 1:length(chromos)) {
+ 		current<-pos.chr==i
+ 		pos.pos[current]<-round(runif(sum(current), 1, chromos[i]))
+ 		str[current]<-(rbinom(sum(current), 1, 0.5)==1);
+ 	}
+ 	simsam(outfname, names(chromos)[pos.chr], pos.pos, str, chromos);
+ }
> 
> expectedRanges <- function(width, offset, spacing, bam.files, restrict=NULL) {
+ 	spacing<-as.integer(spacing)
+ 	width<-as.integer(width)
+ 	offset<-as.integer(offset)
+ 	chrs<-scanBamHeader(bam.files[1])[[1]][[1]]
+ 	output<-list()
+ 	if (!is.null(restrict)) { chrs <- chrs[names(chrs) %in% restrict] }
+ 
+ 	for (x in names(chrs)) {
+ 		multiples<-as.integer((chrs[[x]]-1L)/spacing)
+ 		all.starts<-0:multiples*spacing+1L-offset
+ 		all.ends<-all.starts+width-1L
+ 		all.starts<-pmax(all.starts, 1L)
+ 		all.ends<-pmin(all.ends, chrs[[x]])
+ 
+ 		gr <-GRanges(x, IRanges(all.starts, all.ends))
+ 		keep <- !GenomicRanges::duplicated(gr)
+ 		output[[length(output)+1L]]<- gr[keep]
+ 	}
+ 	output<-suppressWarnings(do.call(c, output))
+ 	return(output)
+ }
> 
> compare2Ranges <- function(left, right) {
+ 	left<-sort(left)
+ 	right<-sort(right)
+ 	if (length(left)!=length(right)) { return(TRUE) }
+ 	if (any(as.character(seqnames(left))!=as.character(seqnames(right))) ||
+ 	    any(start(left)!=start(right)) || any((end(left)!=end(right)))) { return(TRUE); }
+ 	return(FALSE)
+ }
> 
> # We also set up a comparison function between the windowCount function and its countOverlaps equivalent.
> 
> comp <- function(bamFiles, fraglen=200, right=0, left=0, spacing=20, filter=-1, discard=NULL, restrict=NULL) {
+ 	x<-windowCounts(bamFiles, ext=fraglen, right=right, left=left, spacing=spacing, filter=filter, 
+ 		discard=discard, restrict=restrict)
+ 
+ 	# Checking with countOverlaps.
+ 	totals<-integer(length(bamFiles))
+ 	out<-matrix(0L, length(x$region), length(bamFiles))
+ 	for (i in 1:length(bamFiles)) {
+         reads <- scanBam(bamFiles[i], param = ScanBamParam(what =c("rname", "strand", "pos", "qwidth")))[[1]]
+ 		read.starts<-ifelse(reads[[2]]=="+", reads[[3]], reads[[3]]+reads[[4]]-fraglen)
+ 		read.ends<-read.starts+fraglen-1L
+ 		frags <- GRanges(reads[[1]], IRanges(read.starts, read.ends))
+ 
+ 		# Discarding. No variable read lengths here, so no need to use alignment width.			
+ 		if (!is.null(discard)) { frags <- frags[!overlapsAny(GRanges(reads[[1]], IRanges(reads[[3]], reads[[4]]+reads[[3]]-1L)), discard, type="within")] }
+ 		if (!is.null(restrict)) { frags <- frags[seqnames(frags) %in% restrict] }
+ 		current<-findOverlaps(x$region, frags)
+ 		out[,i]<-tabulate(queryHits(current), nbins=length(x$region))
+ 		totals[i]<-length(frags)
+ 	}
+ 
+ 	if (!identical(out, x$counts)) { stop("mismatch in count matrices") }
+ 	if (!identical(totals, x$totals)) { stop("mismatch in total counts") }
+ 
+ 	# Checking the filter.
+     x2<-windowCounts(bamFiles, ext=fraglen, right=right, left=left, spacing=spacing, filter=-1, 
+ 			discard=discard, restrict=restrict)
+ 	expected<-expectedRanges(right+left+1L, left, spacing, bamFiles, restrict=restrict)
+ 	if (compare2Ranges(expected, x2$region)) { stop("mismatch in expected and unfiltered regions"); }
+ 
+ 	keep<-rowSums(x2$counts)>=filter
+ 	if (!identical(x$counts, x2$count[keep,])) { stop("mismatch in filtered counts"); }
+ 	if (sum(keep)==0 && length(x$region)==0) { } 
+ 	else if (compare2Ranges(x2$region[keep], x$region)) { stop("mismatch in filtered regions"); }
+ 
+ 	# Checking MAPQ filtering.
+ 	xx<-windowCounts(bamFiles, minq=200)
+ 	if (!all(xx$totals==0)) { stop("MAPQ filtering failed") }
+ 	return(x$region);
+ }
> 
> # Bin counts.
> 
> bincomp <- function(bamFiles, binsize=1000L) {
+ 	binsize<-as.integer(binsize+0.5)
+ 	blah<-windowCounts(bamFiles, bin=binsize)	
+ 	if (!identical(blah$totals, as.integer(colSums(blah$counts)+0.5))) { stop("totals do not match up") }
+ 	expected<-expectedRanges(binsize, 0L, binsize, bamFiles)
+ 	chrs<-scanBamHeader(bamFiles)[[1]][[1]]
+ 
+ 	# Counting reads into bins.
+ 	total.out<-list()
+     for (x in runValue(seqnames(blah$region))){
+     	out<-matrix(0L, ceiling(chrs[[x]]/binsize), length(bamFiles))
+ 		for (i in 1:length(bamFiles)) { 
+ 			reads <- scanBam(bamFiles[i], param = ScanBamParam(what =c("rname", "strand", "pos", "qwidth"),
+ 						which=GRanges(x, IRanges(1, chrs[[x]]))))[[1]]
+ 			pos<-ifelse(reads[[2]]=="+", reads[[3]], reads[[3]]+reads[[4]]-1L)
+ 			pos<-pmin(pos, chrs[[x]])
+ 			out[,i]<-tabulate((pos-1L)/binsize+1L, nbins=nrow(out))
+ 		}
+ 
+ 		keep<-rowSums(out)>0L
+ 		testing<-blah$region[seqnames(blah$region)==x]
+ 		expect<-expected[seqnames(expected)==x]
+ 		if (compare2Ranges(testing, expect[keep])) { 
+ 			stop("bins do not match up after filtering") }
+ 		total.out[[x]]<-out[keep,]
+    	}
+ 	total.out<-do.call(rbind, total.out)
+ 	if (!identical(total.out, blah$counts)) { stop("binned counts do not match up") }
+ 	return(blah$totals)
+ }
> 
> ###################################################################################################
> # Setting up some variables to do the comparison.
> 
> dir<-"chip-test";
> dir.create(dir);
> 
> set.seed(2123)
> chromos<-c(chrA=10000, chrB=5000)
> bamFiles<-c(regen(1000, chromos, file.path(dir, "A")), regen(1000, chromos, file.path(dir, "B")))
> 
> # Vanilla comparison.
> 
> comp(bamFiles, fraglen=100, spacing=20)
GRanges with 750 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA     [ 1,  1]      *
    [2]     chrA     [21, 21]      *
    [3]     chrA     [41, 41]      *
    [4]     chrA     [61, 61]      *
    [5]     chrA     [81, 81]      *
    ...      ...          ...    ...
  [746]     chrB [4901, 4901]      *
  [747]     chrB [4921, 4921]      *
  [748]     chrB [4941, 4941]      *
  [749]     chrB [4961, 4961]      *
  [750]     chrB [4981, 4981]      *
  ---
  seqlengths:
    chrA  chrB
   10000  5000
> comp(bamFiles, fraglen=200, spacing=50)
GRanges with 300 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [  1,   1]      *
    [2]     chrA   [ 51,  51]      *
    [3]     chrA   [101, 101]      *
    [4]     chrA   [151, 151]      *
    [5]     chrA   [201, 201]      *
    ...      ...          ...    ...
  [296]     chrB [4751, 4751]      *
  [297]     chrB [4801, 4801]      *
  [298]     chrB [4851, 4851]      *
  [299]     chrB [4901, 4901]      *
  [300]     chrB [4951, 4951]      *
  ---
  seqlengths:
    chrA  chrB
   10000  5000
> 
> bincomp(bamFiles, 1000)
[1] 1000 1000
> bincomp(bamFiles, 123)
[1] 1000 1000
> bincomp(bamFiles, 500)
[1] 1000 1000
> 
> # More complex with right arguments.
> 
> comp(bamFiles, fraglen=100, right=30, spacing=20)
GRanges with 750 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA    [ 1,  31]      *
    [2]     chrA    [21,  51]      *
    [3]     chrA    [41,  71]      *
    [4]     chrA    [61,  91]      *
    [5]     chrA    [81, 111]      *
    ...      ...          ...    ...
  [746]     chrB [4901, 4931]      *
  [747]     chrB [4921, 4951]      *
  [748]     chrB [4941, 4971]      *
  [749]     chrB [4961, 4991]      *
  [750]     chrB [4981, 5000]      *
  ---
  seqlengths:
    chrA  chrB
   10000  5000
> comp(bamFiles, fraglen=200, left=50, spacing=25)
GRanges with 600 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA    [ 1,   1]      *
    [2]     chrA    [ 1,  26]      *
    [3]     chrA    [ 1,  51]      *
    [4]     chrA    [26,  76]      *
    [5]     chrA    [51, 101]      *
    ...      ...          ...    ...
  [596]     chrB [4826, 4876]      *
  [597]     chrB [4851, 4901]      *
  [598]     chrB [4876, 4926]      *
  [599]     chrB [4901, 4951]      *
  [600]     chrB [4926, 4976]      *
  ---
  seqlengths:
    chrA  chrB
   10000  5000
> comp(bamFiles, fraglen=150, right=10, left=10, spacing=30)
GRanges with 501 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [  1,  11]      *
    [2]     chrA   [ 21,  41]      *
    [3]     chrA   [ 51,  71]      *
    [4]     chrA   [ 81, 101]      *
    [5]     chrA   [111, 131]      *
    ...      ...          ...    ...
  [497]     chrB [4851, 4871]      *
  [498]     chrB [4881, 4901]      *
  [499]     chrB [4911, 4931]      *
  [500]     chrB [4941, 4961]      *
  [501]     chrB [4971, 4991]      *
  ---
  seqlengths:
    chrA  chrB
   10000  5000
> 
> # Even more complex, with filtering arguments
> 
> comp(bamFiles, fraglen=100, filter=5)
GRanges with 733 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [ 21,  21]      *
    [2]     chrA   [ 41,  41]      *
    [3]     chrA   [ 61,  61]      *
    [4]     chrA   [ 81,  81]      *
    [5]     chrA   [101, 101]      *
    ...      ...          ...    ...
  [729]     chrB [4901, 4901]      *
  [730]     chrB [4921, 4921]      *
  [731]     chrB [4941, 4941]      *
  [732]     chrB [4961, 4961]      *
  [733]     chrB [4981, 4981]      *
  ---
  seqlengths:
    chrA  chrB
   10000  5000
> comp(bamFiles, fraglen=100, filter=10)
GRanges with 545 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [ 61,  61]      *
    [2]     chrA   [ 81,  81]      *
    [3]     chrA   [101, 101]      *
    [4]     chrA   [121, 121]      *
    [5]     chrA   [181, 181]      *
    ...      ...          ...    ...
  [541]     chrB [4901, 4901]      *
  [542]     chrB [4921, 4921]      *
  [543]     chrB [4941, 4941]      *
  [544]     chrB [4961, 4961]      *
  [545]     chrB [4981, 4981]      *
  ---
  seqlengths:
    chrA  chrB
   10000  5000
> comp(bamFiles, fraglen=200, filter=15)
GRanges with 711 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [ 81,  81]      *
    [2]     chrA   [101, 101]      *
    [3]     chrA   [121, 121]      *
    [4]     chrA   [141, 141]      *
    [5]     chrA   [161, 161]      *
    ...      ...          ...    ...
  [707]     chrB [4901, 4901]      *
  [708]     chrB [4921, 4921]      *
  [709]     chrB [4941, 4941]      *
  [710]     chrB [4961, 4961]      *
  [711]     chrB [4981, 4981]      *
  ---
  seqlengths:
    chrA  chrB
   10000  5000
> 
> # And again, with a different chromosome set-up.
> 
> chromos<-c(chrA=5000, chrB=5000, chrC=8000)
> bamFiles<-c(regen(3000, chromos, file.path(dir, "A")), regen(3000, chromos, file.path(dir, "B")))
> 
> comp(bamFiles, fraglen=100)
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA     [ 1,  1]      *
    [2]     chrA     [21, 21]      *
    [3]     chrA     [41, 41]      *
    [4]     chrA     [61, 61]      *
    [5]     chrA     [81, 81]      *
    ...      ...          ...    ...
  [896]     chrC [7901, 7901]      *
  [897]     chrC [7921, 7921]      *
  [898]     chrC [7941, 7941]      *
  [899]     chrC [7961, 7961]      *
  [900]     chrC [7981, 7981]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200)
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA     [ 1,  1]      *
    [2]     chrA     [21, 21]      *
    [3]     chrA     [41, 41]      *
    [4]     chrA     [61, 61]      *
    [5]     chrA     [81, 81]      *
    ...      ...          ...    ...
  [896]     chrC [7901, 7901]      *
  [897]     chrC [7921, 7921]      *
  [898]     chrC [7941, 7941]      *
  [899]     chrC [7961, 7961]      *
  [900]     chrC [7981, 7981]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> 
> bincomp(bamFiles, 1000)
[1] 3000 3000
> bincomp(bamFiles, 123)
[1] 3000 3000
> bincomp(bamFiles, 500)
[1] 3000 3000
> 
> comp(bamFiles, fraglen=100, right=100)
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA    [ 1, 101]      *
    [2]     chrA    [21, 121]      *
    [3]     chrA    [41, 141]      *
    [4]     chrA    [61, 161]      *
    [5]     chrA    [81, 181]      *
    ...      ...          ...    ...
  [896]     chrC [7901, 8000]      *
  [897]     chrC [7921, 8000]      *
  [898]     chrC [7941, 8000]      *
  [899]     chrC [7961, 8000]      *
  [900]     chrC [7981, 8000]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200, left=50)
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA     [ 1,  1]      *
    [2]     chrA     [ 1, 21]      *
    [3]     chrA     [ 1, 41]      *
    [4]     chrA     [11, 61]      *
    [5]     chrA     [31, 81]      *
    ...      ...          ...    ...
  [896]     chrC [7851, 7901]      *
  [897]     chrC [7871, 7921]      *
  [898]     chrC [7891, 7941]      *
  [899]     chrC [7911, 7961]      *
  [900]     chrC [7931, 7981]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> 
> comp(bamFiles, fraglen=200, right=0, spacing=20)
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA     [ 1,  1]      *
    [2]     chrA     [21, 21]      *
    [3]     chrA     [41, 41]      *
    [4]     chrA     [61, 61]      *
    [5]     chrA     [81, 81]      *
    ...      ...          ...    ...
  [896]     chrC [7901, 7901]      *
  [897]     chrC [7921, 7921]      *
  [898]     chrC [7941, 7941]      *
  [899]     chrC [7961, 7961]      *
  [900]     chrC [7981, 7981]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200, left=100, spacing=100)
GRanges with 180 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [  1,   1]      *
    [2]     chrA   [  1, 101]      *
    [3]     chrA   [101, 201]      *
    [4]     chrA   [201, 301]      *
    [5]     chrA   [301, 401]      *
    ...      ...          ...    ...
  [176]     chrC [7401, 7501]      *
  [177]     chrC [7501, 7601]      *
  [178]     chrC [7601, 7701]      *
  [179]     chrC [7701, 7801]      *
  [180]     chrC [7801, 7901]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> 
> comp(bamFiles, fraglen=100, filter=20)
GRanges with 832 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA     [ 1,  1]      *
    [2]     chrA     [21, 21]      *
    [3]     chrA     [41, 41]      *
    [4]     chrA     [61, 61]      *
    [5]     chrA     [81, 81]      *
    ...      ...          ...    ...
  [828]     chrC [7821, 7821]      *
  [829]     chrC [7841, 7841]      *
  [830]     chrC [7861, 7861]      *
  [831]     chrC [7881, 7881]      *
  [832]     chrC [7901, 7901]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200, filter=40)
GRanges with 865 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA     [ 1,  1]      *
    [2]     chrA     [21, 21]      *
    [3]     chrA     [41, 41]      *
    [4]     chrA     [61, 61]      *
    [5]     chrA     [81, 81]      *
    ...      ...          ...    ...
  [861]     chrC [7781, 7781]      *
  [862]     chrC [7801, 7801]      *
  [863]     chrC [7821, 7821]      *
  [864]     chrC [7841, 7841]      *
  [865]     chrC [7861, 7861]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200, filter=60)
GRanges with 512 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [ 81,  81]      *
    [2]     chrA   [101, 101]      *
    [3]     chrA   [121, 121]      *
    [4]     chrA   [141, 141]      *
    [5]     chrA   [161, 161]      *
    ...      ...          ...    ...
  [508]     chrC [6241, 6241]      *
  [509]     chrC [6261, 6261]      *
  [510]     chrC [6281, 6281]      *
  [511]     chrC [6301, 6301]      *
  [512]     chrC [6321, 6321]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> 
> # One more time; sparse across the genome.
> 
> chromos<-c(chrA=5000, chrB=5000, chrC=8000)
> bamFiles<-c(regen(100, chromos, file.path(dir, "A")), regen(100, chromos, file.path(dir, "B")))
> 
> comp(bamFiles, fraglen=100)
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA     [ 1,  1]      *
    [2]     chrA     [21, 21]      *
    [3]     chrA     [41, 41]      *
    [4]     chrA     [61, 61]      *
    [5]     chrA     [81, 81]      *
    ...      ...          ...    ...
  [896]     chrC [7901, 7901]      *
  [897]     chrC [7921, 7921]      *
  [898]     chrC [7941, 7941]      *
  [899]     chrC [7961, 7961]      *
  [900]     chrC [7981, 7981]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200)
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA     [ 1,  1]      *
    [2]     chrA     [21, 21]      *
    [3]     chrA     [41, 41]      *
    [4]     chrA     [61, 61]      *
    [5]     chrA     [81, 81]      *
    ...      ...          ...    ...
  [896]     chrC [7901, 7901]      *
  [897]     chrC [7921, 7921]      *
  [898]     chrC [7941, 7941]      *
  [899]     chrC [7961, 7961]      *
  [900]     chrC [7981, 7981]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> 
> bincomp(bamFiles, 1000)
[1] 100 100
> bincomp(bamFiles, 123)
[1] 100 100
> bincomp(bamFiles, 500)
[1] 100 100
> 
> comp(bamFiles, fraglen=100, left=100)
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA      [1,  1]      *
    [2]     chrA      [1, 21]      *
    [3]     chrA      [1, 41]      *
    [4]     chrA      [1, 61]      *
    [5]     chrA      [1, 81]      *
    ...      ...          ...    ...
  [896]     chrC [7801, 7901]      *
  [897]     chrC [7821, 7921]      *
  [898]     chrC [7841, 7941]      *
  [899]     chrC [7861, 7961]      *
  [900]     chrC [7881, 7981]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200, right=50)
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA    [ 1,  51]      *
    [2]     chrA    [21,  71]      *
    [3]     chrA    [41,  91]      *
    [4]     chrA    [61, 111]      *
    [5]     chrA    [81, 131]      *
    ...      ...          ...    ...
  [896]     chrC [7901, 7951]      *
  [897]     chrC [7921, 7971]      *
  [898]     chrC [7941, 7991]      *
  [899]     chrC [7961, 8000]      *
  [900]     chrC [7981, 8000]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> 
> comp(bamFiles, fraglen=200, left=0, spacing=50)
GRanges with 360 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [  1,   1]      *
    [2]     chrA   [ 51,  51]      *
    [3]     chrA   [101, 101]      *
    [4]     chrA   [151, 151]      *
    [5]     chrA   [201, 201]      *
    ...      ...          ...    ...
  [356]     chrC [7751, 7751]      *
  [357]     chrC [7801, 7801]      *
  [358]     chrC [7851, 7851]      *
  [359]     chrC [7901, 7901]      *
  [360]     chrC [7951, 7951]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200, right=100, spacing=100)
GRanges with 180 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [  1, 101]      *
    [2]     chrA   [101, 201]      *
    [3]     chrA   [201, 301]      *
    [4]     chrA   [301, 401]      *
    [5]     chrA   [401, 501]      *
    ...      ...          ...    ...
  [176]     chrC [7501, 7601]      *
  [177]     chrC [7601, 7701]      *
  [178]     chrC [7701, 7801]      *
  [179]     chrC [7801, 7901]      *
  [180]     chrC [7901, 8000]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> 
> comp(bamFiles, fraglen=100, filter=0)
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA     [ 1,  1]      *
    [2]     chrA     [21, 21]      *
    [3]     chrA     [41, 41]      *
    [4]     chrA     [61, 61]      *
    [5]     chrA     [81, 81]      *
    ...      ...          ...    ...
  [896]     chrC [7901, 7901]      *
  [897]     chrC [7921, 7921]      *
  [898]     chrC [7941, 7941]      *
  [899]     chrC [7961, 7961]      *
  [900]     chrC [7981, 7981]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200, filter=1)
GRanges with 796 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [ 41,  41]      *
    [2]     chrA   [ 61,  61]      *
    [3]     chrA   [ 81,  81]      *
    [4]     chrA   [101, 101]      *
    [5]     chrA   [121, 121]      *
    ...      ...          ...    ...
  [792]     chrC [7761, 7761]      *
  [793]     chrC [7781, 7781]      *
  [794]     chrC [7801, 7801]      *
  [795]     chrC [7821, 7821]      *
  [796]     chrC [7841, 7841]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200, right=50, filter=2)
GRanges with 681 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [281, 331]      *
    [2]     chrA   [301, 351]      *
    [3]     chrA   [321, 371]      *
    [4]     chrA   [341, 391]      *
    [5]     chrA   [361, 411]      *
    ...      ...          ...    ...
  [677]     chrC [7721, 7771]      *
  [678]     chrC [7741, 7791]      *
  [679]     chrC [7761, 7811]      *
  [680]     chrC [7781, 7831]      *
  [681]     chrC [7801, 7851]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> 
> ###################################################################################################
> # We test with four files. Oh, the humanity.
> 
> bamFiles<-sapply(1:4, FUN=function(i) { regen(3000, chromos, file.path(dir, paste("A", i, sep=""))) })
> 
> comp(bamFiles, fraglen=100)
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA     [ 1,  1]      *
    [2]     chrA     [21, 21]      *
    [3]     chrA     [41, 41]      *
    [4]     chrA     [61, 61]      *
    [5]     chrA     [81, 81]      *
    ...      ...          ...    ...
  [896]     chrC [7901, 7901]      *
  [897]     chrC [7921, 7921]      *
  [898]     chrC [7941, 7941]      *
  [899]     chrC [7961, 7961]      *
  [900]     chrC [7981, 7981]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200)
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA     [ 1,  1]      *
    [2]     chrA     [21, 21]      *
    [3]     chrA     [41, 41]      *
    [4]     chrA     [61, 61]      *
    [5]     chrA     [81, 81]      *
    ...      ...          ...    ...
  [896]     chrC [7901, 7901]      *
  [897]     chrC [7921, 7921]      *
  [898]     chrC [7941, 7941]      *
  [899]     chrC [7961, 7961]      *
  [900]     chrC [7981, 7981]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> 
> bincomp(bamFiles, 1000)
[1] 3000 3000 3000 3000
> bincomp(bamFiles, 123)
[1] 3000 3000 3000 3000
> bincomp(bamFiles, 500)
[1] 3000 3000 3000 3000
> 
> comp(bamFiles, fraglen=100, right=100)
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA    [ 1, 101]      *
    [2]     chrA    [21, 121]      *
    [3]     chrA    [41, 141]      *
    [4]     chrA    [61, 161]      *
    [5]     chrA    [81, 181]      *
    ...      ...          ...    ...
  [896]     chrC [7901, 8000]      *
  [897]     chrC [7921, 8000]      *
  [898]     chrC [7941, 8000]      *
  [899]     chrC [7961, 8000]      *
  [900]     chrC [7981, 8000]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200, right=50)
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA    [ 1,  51]      *
    [2]     chrA    [21,  71]      *
    [3]     chrA    [41,  91]      *
    [4]     chrA    [61, 111]      *
    [5]     chrA    [81, 131]      *
    ...      ...          ...    ...
  [896]     chrC [7901, 7951]      *
  [897]     chrC [7921, 7971]      *
  [898]     chrC [7941, 7991]      *
  [899]     chrC [7961, 8000]      *
  [900]     chrC [7981, 8000]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> 
> comp(bamFiles, fraglen=200, right=0, spacing=40)
GRanges with 450 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [  1,   1]      *
    [2]     chrA   [ 41,  41]      *
    [3]     chrA   [ 81,  81]      *
    [4]     chrA   [121, 121]      *
    [5]     chrA   [161, 161]      *
    ...      ...          ...    ...
  [446]     chrC [7801, 7801]      *
  [447]     chrC [7841, 7841]      *
  [448]     chrC [7881, 7881]      *
  [449]     chrC [7921, 7921]      *
  [450]     chrC [7961, 7961]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200, right=100, spacing=100)
GRanges with 180 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [  1, 101]      *
    [2]     chrA   [101, 201]      *
    [3]     chrA   [201, 301]      *
    [4]     chrA   [301, 401]      *
    [5]     chrA   [401, 501]      *
    ...      ...          ...    ...
  [176]     chrC [7501, 7601]      *
  [177]     chrC [7601, 7701]      *
  [178]     chrC [7701, 7801]      *
  [179]     chrC [7801, 7901]      *
  [180]     chrC [7901, 8000]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> 
> comp(bamFiles, fraglen=200, filter=100)
GRanges with 649 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [ 61,  61]      *
    [2]     chrA   [ 81,  81]      *
    [3]     chrA   [101, 101]      *
    [4]     chrA   [121, 121]      *
    [5]     chrA   [141, 141]      *
    ...      ...          ...    ...
  [645]     chrC [7321, 7321]      *
  [646]     chrC [7341, 7341]      *
  [647]     chrC [7361, 7361]      *
  [648]     chrC [7381, 7381]      *
  [649]     chrC [7441, 7441]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200, filter=150)
GRanges with 363 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [181, 181]      *
    [2]     chrA   [201, 201]      *
    [3]     chrA   [221, 221]      *
    [4]     chrA   [241, 241]      *
    [5]     chrA   [261, 261]      *
    ...      ...          ...    ...
  [359]     chrB [4781, 4781]      *
  [360]     chrB [4801, 4801]      *
  [361]     chrB [4821, 4821]      *
  [362]     chrB [4841, 4841]      *
  [363]     chrB [4861, 4861]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> 
> ###################################################################################################
> # We try to do some crazy spacing.
> 
> chromos<-c(chrA=8000, chrB=8000)
> bamFiles<-c(regen(3000, chromos, file.path(dir, "A")), regen(3000, chromos, file.path(dir, "B")))
> 
> comp(bamFiles, spacing=max(chromos))
GRanges with 2 ranges and 0 metadata columns:
      seqnames    ranges strand
         <Rle> <IRanges>  <Rle>
  [1]     chrA    [1, 1]      *
  [2]     chrB    [1, 1]      *
  ---
  seqlengths:
   chrA chrB
   8000 8000
> 
> # We also try to do some crazy extension. We should see 1 combination per chromosome, consisting of all reads.
> 
> comp(bamFiles, right=max(chromos), left=max(chromos))
GRanges with 2 ranges and 0 metadata columns:
      seqnames    ranges strand
         <Rle> <IRanges>  <Rle>
  [1]     chrA [1, 8000]      *
  [2]     chrB [1, 8000]      *
  ---
  seqlengths:
   chrA chrB
   8000 8000
> 
> ###################################################################################################
> # Restricted and/or discarded.
> 
> chromos<-c(chrA=5000, chrB=5000, chrC=8000)
> bamFiles<-c(regen(100, chromos, file.path(dir, "A")), regen(100, chromos, file.path(dir, "B")))
> 
> makeDiscard <- function(ndisc, sizeof) {
+ 	chosen <- sample(length(chromos), ndisc, replace=T)
+ 	chosen.pos <- runif(ndisc, 1, chromos[chosen]-sizeof)
+ 	GRanges(names(chromos)[chosen], IRanges(chosen.pos, chosen.pos+sizeof))
+ }
> 
> comp(bamFiles, fraglen=100, discard=makeDiscard(10, 200))
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA     [ 1,  1]      *
    [2]     chrA     [21, 21]      *
    [3]     chrA     [41, 41]      *
    [4]     chrA     [61, 61]      *
    [5]     chrA     [81, 81]      *
    ...      ...          ...    ...
  [896]     chrC [7901, 7901]      *
  [897]     chrC [7921, 7921]      *
  [898]     chrC [7941, 7941]      *
  [899]     chrC [7961, 7961]      *
  [900]     chrC [7981, 7981]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200, discard=makeDiscard(20, 100), restrict="chrA")
GRanges with 250 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA     [ 1,  1]      *
    [2]     chrA     [21, 21]      *
    [3]     chrA     [41, 41]      *
    [4]     chrA     [61, 61]      *
    [5]     chrA     [81, 81]      *
    ...      ...          ...    ...
  [246]     chrA [4901, 4901]      *
  [247]     chrA [4921, 4921]      *
  [248]     chrA [4941, 4941]      *
  [249]     chrA [4961, 4961]      *
  [250]     chrA [4981, 4981]      *
  ---
  seqlengths:
   chrA
   5000
> 
> comp(bamFiles, fraglen=100, left=100, discard=makeDiscard(50, 20))
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA      [1,  1]      *
    [2]     chrA      [1, 21]      *
    [3]     chrA      [1, 41]      *
    [4]     chrA      [1, 61]      *
    [5]     chrA      [1, 81]      *
    ...      ...          ...    ...
  [896]     chrC [7801, 7901]      *
  [897]     chrC [7821, 7921]      *
  [898]     chrC [7841, 7941]      *
  [899]     chrC [7861, 7961]      *
  [900]     chrC [7881, 7981]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200, right=50, discard=makeDiscard(10, 200), restrict=c("chrA", "chrB"))
GRanges with 500 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA    [ 1,  51]      *
    [2]     chrA    [21,  71]      *
    [3]     chrA    [41,  91]      *
    [4]     chrA    [61, 111]      *
    [5]     chrA    [81, 131]      *
    ...      ...          ...    ...
  [496]     chrB [4901, 4951]      *
  [497]     chrB [4921, 4971]      *
  [498]     chrB [4941, 4991]      *
  [499]     chrB [4961, 5000]      *
  [500]     chrB [4981, 5000]      *
  ---
  seqlengths:
   chrA chrB
   5000 5000
> 
> comp(bamFiles, fraglen=200, left=0, spacing=50, discard=makeDiscard(20, 200))
GRanges with 360 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [  1,   1]      *
    [2]     chrA   [ 51,  51]      *
    [3]     chrA   [101, 101]      *
    [4]     chrA   [151, 151]      *
    [5]     chrA   [201, 201]      *
    ...      ...          ...    ...
  [356]     chrC [7751, 7751]      *
  [357]     chrC [7801, 7801]      *
  [358]     chrC [7851, 7851]      *
  [359]     chrC [7901, 7901]      *
  [360]     chrC [7951, 7951]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200, right=100, spacing=100, discard=makeDiscard(10, 1000))
GRanges with 180 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [  1, 101]      *
    [2]     chrA   [101, 201]      *
    [3]     chrA   [201, 301]      *
    [4]     chrA   [301, 401]      *
    [5]     chrA   [401, 501]      *
    ...      ...          ...    ...
  [176]     chrC [7501, 7601]      *
  [177]     chrC [7601, 7701]      *
  [178]     chrC [7701, 7801]      *
  [179]     chrC [7801, 7901]      *
  [180]     chrC [7901, 8000]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> 
> comp(bamFiles, fraglen=100, filter=0, discard=makeDiscard(10, 500))
GRanges with 900 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA     [ 1,  1]      *
    [2]     chrA     [21, 21]      *
    [3]     chrA     [41, 41]      *
    [4]     chrA     [61, 61]      *
    [5]     chrA     [81, 81]      *
    ...      ...          ...    ...
  [896]     chrC [7901, 7901]      *
  [897]     chrC [7921, 7921]      *
  [898]     chrC [7941, 7941]      *
  [899]     chrC [7961, 7961]      *
  [900]     chrC [7981, 7981]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> comp(bamFiles, fraglen=200, filter=1, discard=makeDiscard(5, 1000), restrict=c("chrC", "chrA"))
GRanges with 524 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [  1,   1]      *
    [2]     chrA   [ 21,  21]      *
    [3]     chrA   [ 41,  41]      *
    [4]     chrA   [ 81,  81]      *
    [5]     chrA   [101, 101]      *
    ...      ...          ...    ...
  [520]     chrC [7901, 7901]      *
  [521]     chrC [7921, 7921]      *
  [522]     chrC [7941, 7941]      *
  [523]     chrC [7961, 7961]      *
  [524]     chrC [7981, 7981]      *
  ---
  seqlengths:
   chrA chrC
   5000 8000
> comp(bamFiles, fraglen=200, right=50, filter=2, discard=makeDiscard(20, 100))
GRanges with 635 ranges and 0 metadata columns:
        seqnames       ranges strand
           <Rle>    <IRanges>  <Rle>
    [1]     chrA   [  1,  51]      *
    [2]     chrA   [ 21,  71]      *
    [3]     chrA   [ 41,  91]      *
    [4]     chrA   [101, 151]      *
    [5]     chrA   [121, 171]      *
    ...      ...          ...    ...
  [631]     chrC [7901, 7951]      *
  [632]     chrC [7921, 7971]      *
  [633]     chrC [7941, 7991]      *
  [634]     chrC [7961, 8000]      *
  [635]     chrC [7981, 8000]      *
  ---
  seqlengths:
   chrA chrB chrC
   5000 5000 8000
> 
> ###################################################################################################
> # Cleaning up.
> 
> unlink(dir, recursive=TRUE)
> 
> ###################################################################################################
> # End.
> 
> 
> proc.time()
   user  system elapsed 
 65.519   0.423  66.135 
